import{r,c7 as N,c8 as O,cN as L,J as Q,w as x,cR as P,j as R}from"./sanity-b2fc26b5.js";import{c as U,a as $,g as k,b as _}from"./PresentationToolGrantsCheck-5cae0952.js";import{b as F,u as K,a as V}from"./hooks-13fc6a51.js";import{i as q}from"./DisplayedDocumentBroadcaster-0bd667e8.js";function W(c){const{liveDocument:m,controller:u,perspective:i,onLoadersConnection:a,onDocumentsOnPage:l}=c,[f,g]=r.useState(),[A,b]=r.useState({}),h=N(),S=O();r.useEffect(()=>{const t=setInterval(()=>b(e=>{if(Object.keys(e).length<1)return e;const o=Date.now();if(!Object.values(e).some(C=>C.heartbeat!==!1&&o>C.receivedAt+C.heartbeat))return e;const w={};for(const[C,M]of Object.entries(e))M.heartbeat!==!1&&o>M.receivedAt+M.heartbeat||(w[C]=M);return w}),L);return()=>clearInterval(t)},[]),r.useEffect(()=>{if(u){const t=u.createConnection({name:"presentation",connectTo:"loaders",heartbeat:!0},U().provide({actors:$()}));return g(t),t.onStatus(a),t.on("loader/documents",e=>{e.projectId===h&&e.dataset===S&&l("loaders",e.perspective,e.documents)}),t.on("loader/query-listen",e=>{if(e.projectId===h&&e.dataset===S){if(typeof e.heartbeat=="number"&&e.heartbeat<L)throw new Error(`Loader query listen heartbeat interval must be at least ${L}ms`);b(o=>({...o,[k(e.query,e.params)]:{perspective:e.perspective,query:e.query,params:e.params,receivedAt:Date.now(),heartbeat:e.heartbeat??!1}}))}}),t.start()}},[u,S,l,a,h]);const[E]=r.useState(()=>new Set),[d,p]=r.useState(null),n=Q({apiVersion:"2023-10-16"}),y=r.useMemo(()=>n.config(),[n]),j=r.useMemo(()=>n.withConfig({resultSourceMap:"withKeyArraySelector"}),[n]);r.useEffect(()=>{if(f){const{projectId:t,dataset:e}=y;f.post({type:"loader/perspective",data:{projectId:t,dataset:e,perspective:i}})}},[f,y,i]);const I=x(t=>{const e=Array.from(E).flat();t.tags.some(o=>e.includes(o))?p(t.id):console.log("No matching tags found",t.tags,{flattenedSyncTags:e})});r.useEffect(()=>{const t=P(j.config()).withConfig({apiVersion:"vX"}).live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:e=>{e.type==="message"?I(e):e.type==="restart"?p(e.id):e.type==="reconnect"&&p(null)},error:e=>console.error("Error validating EventSource URL:",e)});return()=>t.unsubscribe()},[j,I]);const T=r.useDeferredValue(m);return R.jsx(R.Fragment,{children:Object.entries(A).map(([t,{query:e,params:o,perspective:w}])=>R.jsx(D,{projectId:y.projectId,dataset:y.dataset,perspective:w,query:e,params:o,comlink:f,client:j,liveDocument:T,lastLiveEventId:d,syncTagsInUse:E},`${t}${w}`))})}function B(c){const{projectId:m,dataset:u,perspective:i,query:a,client:l,liveDocument:f,comlink:g,lastLiveEventId:A,syncTagsInUse:b}=c,h=K(c.params),{result:S,resultSourceMap:E,syncTags:d}=H({client:l,liveDocument:f,params:h,perspective:i,query:a,lastLiveEventId:A})||{},p=x((n,y,j,I,T,t,e)=>{n==null||n.post({type:"loader/query-change",data:{projectId:m,dataset:u,perspective:y,query:j,params:I,result:T,resultSourceMap:t,tags:e}})});return r.useEffect(()=>{if(E&&p(g,i,a,h,S,E,d),Array.isArray(d))return b.add(d),()=>{b.delete(d)}},[g,p,h,i,a,S,E,b,d]),null}const D=r.memo(B);D.displayName="Memo(QuerySubscription)";function H(c){const{liveDocument:m,client:u,query:i,params:a,perspective:l,lastLiveEventId:f}=c,[g,A]=r.useState(null),[b,h]=r.useState(null);if(b)throw b;const[S,E]=V({refreshInterval:0}),d=S==="refresh"||S==="inflight"||f!==(g==null?void 0:g.lastLiveEventId);r.useEffect(()=>{if(!d)return;let j=!1,I=!1;const T=new AbortController;async function t(){const{signal:o}=T;I=!0;const{result:w,resultSourceMap:C,syncTags:M}=await u.fetch(i,a,{lastLiveEventId:f,tag:"presentation-loader",signal:o,perspective:l,filterResponse:!1,returnQuery:!1});I=!1,o.aborted||(A(s=>({result:q(s==null?void 0:s.result,w)?s==null?void 0:s.result:w,resultSourceMap:q(s==null?void 0:s.resultSourceMap,C)?s==null?void 0:s.resultSourceMap:C,syncTags:q(s==null?void 0:s.syncTags,M)?s==null?void 0:s.syncTags:M,lastLiveEventId:f})),j=!0)}const e=E();return t().catch(o=>{I=!1,o.name!=="AbortError"&&h(o)}).finally(e),()=>{!j&&!I&&T.abort()}},[u,f,a,l,i,d,E]);const{result:p,resultSourceMap:n,syncTags:y}=g??{};return r.useMemo(()=>m&&n?{result:J(m,p,l,n),resultSourceMap:n,syncTags:y}:{result:p,resultSourceMap:n,syncTags:y},[m,l,p,n,y])}function J(c,m,u,i){if(u==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return F(m,i,a=>{if(!a._projectId&&(c!=null&&c._id)&&_(c._id)===_(a._id))return c},(a,{previousValue:l})=>typeof a=="number"&&typeof l=="string"?`${a}`:a,u)}export{W as default,J as turboChargeResultIfSourceMap};
